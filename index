<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Rue aux Enfants üöê</title>

<style>
body{
    margin:0;
    background:#222;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:Arial, sans-serif;
}
canvas{
    background:#333;
    border-radius:12px;
}
</style>
</head>

<body>
<canvas id="game" width="480" height="700"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const W = canvas.width;
const H = canvas.height;

const LANES = [W/4, W/2, 3*W/4];
const PLAYER_Y = H - 120;

let BASE_SPEED = 6;
let SPAWN_DELAY = 700;

let playerLane = 1;

let children = [];
let police = [];
let obstacles = [];

let score = 0;
let gameOver = false;

let lastSpawn = 0;

let bestScore = Number(localStorage.getItem("bestScore") || 0);

//////////////////////////////////////////////////
// PLAYER
//////////////////////////////////////////////////

const player = {
    w:60,
    h:90,
    x:LANES[playerLane],
    y:PLAYER_Y
};

//////////////////////////////////////////////////
// CONTROLES
//////////////////////////////////////////////////

document.addEventListener("keydown", e => {
    if(!gameOver){
        if(e.key === "ArrowLeft" && playerLane > 0) playerLane--;
        if(e.key === "ArrowRight" && playerLane < 2) playerLane--;
        if(e.key === "ArrowRight" && playerLane < 2) playerLane++;
        player.x = LANES[playerLane];
    }
    else{
        if(e.key === "r" || e.key === "R") restart();
    }
});

//////////////////////////////////////////////////
// UTIL
//////////////////////////////////////////////////

function rectsCollide(a,b){
    return a.x-a.w/2 < b.x+b.w/2 &&
           a.x+a.w/2 > b.x-b.w/2 &&
           a.y-a.h/2 < b.y+b.h/2 &&
           a.y+a.h/2 > b.y-b.h/2;
}

function randLane(){
    return LANES[Math.floor(Math.random()*3)];
}

//////////////////////////////////////////////////
// SPAWN
//////////////////////////////////////////////////

function spawn(){
    for(let i=0;i<2;i++){
        children.push({
            x:randLane(),
            y:-40,
            w:40,
            h:50
        });
    }

    if(Math.random() < 0.8){
        police.push({
            x:randLane(),
            y:-40,
            w:40,
            h:50
        });
    }

    if(Math.random() < 0.7){
        obstacles.push({
            x:randLane(),
            y:-60,
            w:60,
            h:80
        });
    }
}

//////////////////////////////////////////////////
// DRAW
//////////////////////////////////////////////////

function drawRect(x,y,w,h,color){
    ctx.fillStyle = color;
    ctx.fillRect(x-w/2, y-h/2, w, h);
}

function drawBackground(offset){
    ctx.fillStyle="#303030";
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle="#606060";
    ctx.fillRect(0,0,80,H);
    ctx.fillRect(W-80,0,80,H);

    ctx.strokeStyle="#888";
    ctx.lineWidth=2;
    LANES.forEach(x=>{
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,H);
        ctx.stroke();
    });

    for(let y=-100;y<H;y+=160){
        ctx.fillStyle="#777";
        ctx.fillRect(10,(y+offset)%H,60,120);
        ctx.fillRect(W-70,(y+offset)%H,60,120);
    }
}

function drawUI(){
    ctx.fillStyle="white";
    ctx.font="20px Arial";
    ctx.fillText("Score : "+score, 10, 25);
    ctx.fillStyle="gold";
    ctx.fillText("Best : "+bestScore, 10, 50);

    if(gameOver){
        ctx.fillStyle="red";
        ctx.font="30px Arial";
        ctx.fillText("GAME OVER", 120, H/2);
        ctx.font="20px Arial";
        ctx.fillText("Appuie sur R", 160, H/2+30);
    }
}

//////////////////////////////////////////////////
// RESTART
//////////////////////////////////////////////////

function restart(){
    children=[];
    police=[];
    obstacles=[];
    score=0;
    playerLane=1;
    player.x=LANES[playerLane];
    gameOver=false;
}

//////////////////////////////////////////////////
// LOOP
//////////////////////////////////////////////////

let lastTime=0;
let bgOffset=0;

function loop(time){
    let dt=time-lastTime;
    lastTime=time;

    let speed = BASE_SPEED + score*0.03;
    bgOffset += speed;

    if(!gameOver){

        if(time-lastSpawn > SPAWN_DELAY){
            spawn();
            lastSpawn=time;
        }

        children.forEach((c,i)=>{
            c.y += speed;
            if(rectsCollide(player,c)){
                score++;
                children.splice(i,1);
            }
        });

        police.forEach((p,i)=>{
            p.y += speed;
            if(rectsCollide(player,p)){
                gameOver=true;
            }
        });

        obstacles.forEach((o,i)=>{
            o.y += speed;
            if(rectsCollide(player,o)){
                gameOver=true;
            }
        });

        if(score > bestScore){
            bestScore = score;
            localStorage.setItem("bestScore", bestScore);
        }
    }

    //////////////////////////////////////////////////
    // DRAW
    //////////////////////////////////////////////////

    drawBackground(bgOffset);

    children.forEach(c=>drawRect(c.x,c.y,c.w,c.h,"#ff5555"));
    police.forEach(p=>drawRect(p.x,p.y,p.w,p.h,"#0044cc"));
    obstacles.forEach(o=>drawRect(o.x,o.y,o.w,o.h,"#33aa33"));

    drawRect(player.x,player.y,player.w,player.h,"#dddddd");

    drawUI();

    requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>
